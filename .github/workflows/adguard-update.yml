name: Update AdGuard Filters

on:
  schedule:
    # 每天北京时间早上 4:00 执行 (UTC 20:00)
    # 你可以根据需要调整时间，例如 UTC 0:00 对应北京时间 8:00
    - cron: '0 20 * * *'
  workflow_dispatch:
    # 允许手动触发

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 1. Download and Merge Filters
        run: |
          # 创建或清空临时文件
          > AdGE.txt
          
          URLS=(
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_2_Base/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_3_Spyware/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_17_TrackParam/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_14_Annoyances/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_18_Annoyances_Cookies/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_19_Annoyances_Popups/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_20_Annoyances_MobileApp/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_22_Annoyances_Widgets/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_21_Annoyances_Other/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_224_Chinese/filter.txt"
          )

          echo "开始下载并拼接规则..."
          for url in "${URLS[@]}"; do
            echo "Downloading: $url"
            # 下载并追加，确保末尾换行
            curl -sSL "$url" >> AdGE.txt
            echo -e "\n" >> AdGE.txt
          done
          
          echo "拼接完成，临时文件大小："
          ls -lh AdGE.txt

      - name: 2. Install hostlist-compiler
        run: npm install -g @adguard/hostlist-compiler

      - name: 3. Compress and Compile
        run: |
          # 创建临时配置 config.json
          cat <<EOF > config.json
          {
            "name": "AdGuard Extension Merge",
            "description": "Merged AdGuard filters with Deduplication",
            "version": "1.0.$(date +%s)",
            "homepage": "https://github.com/${{ github.repository }}",
            "sources": [
              {
                "source": "AdGE.txt",
                "type": "adblock"
              }
            ]
          }
          EOF

          # 编译生成 AdGuardExtension.txt
          hostlist-compiler -c config.json -o AdGuardExtension.txt
          
          # 【要求1】删除原始拼接文件和临时配置，不推送到仓库
          rm AdGE.txt config.json

      - name: 4. Deduplicate against Upstream
        shell: python
        run: |
          import urllib.request
          import os

          local_file = "AdGuardExtension.txt"
          upstream_url = "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt"
          
          print(f"正在下载参照列表: {upstream_url}")
          try:
              # 下载参照列表内容
              with urllib.request.urlopen(upstream_url) as response:
                  upstream_data = response.read().decode('utf-8')
              
              # 将参照列表转为 Set 集合（自动去重且查找速度快）
              # 使用 strip() 去除首尾空格，确保精确匹配
              upstream_rules = set(line.strip() for line in upstream_data.splitlines() if line.strip())
              print(f"参照列表规则数: {len(upstream_rules)}")

              # 读取本地生成的文件
              if not os.path.exists(local_file):
                  print("错误: AdGuardExtension.txt 不存在")
                  exit(1)

              with open(local_file, 'r', encoding='utf-8') as f:
                  local_lines = f.readlines()
              
              original_count = len(local_lines)
              print(f"本地原始规则数: {original_count}")

              # 开始比对去重
              new_lines = []
              removed_count = 0
              
              # 保留文件头部的注释（通常以 ! 开头）或者是元数据
              # 如果你想严格去除，也可以把注释加入比对
              for line in local_lines:
                  clean_line = line.strip()
                  
                  # 逻辑：如果这一行不为空，且存在于参照列表中，则跳过（即删除）
                  # 注意：这里我们保留了注释行，除非注释行也一模一样
                  if clean_line and clean_line in upstream_rules:
                      removed_count += 1
                  else:
                      new_lines.append(line)

              print(f"剔除重复规则数: {removed_count}")
              print(f"剩余规则数: {len(new_lines)}")

              # 写回文件
              with open(local_file, 'w', encoding='utf-8') as f:
                  f.writelines(new_lines)

          except Exception as e:
              print(f"去重脚本出错: {e}")
              exit(1)

      - name: 5. Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 只添加结果文件
          git add AdGuardExtension.txt
          
          # 检查是否有实质性变更
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update filters: Deduplicated $(date +'%Y-%m-%d')"
            git push
          fi
