name: Update AdGuard uBlock MixedFilters

on:
  schedule:
    # 每天北京时间早上 5:00 执行 (UTC 21:00)
    - cron: '0 21 * * *'
  workflow_dispatch:
    # 允许手动触发

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 1. Download and Merge Filters
        run: |
          # 创建或清空临时文件
          > AdGE_uB_Mixed.txt
          
          URLS=(
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_2_Base/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_3_Spyware/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_17_TrackParam/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_14_Annoyances/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_18_Annoyances_Cookies/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_19_Annoyances_Popups/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_20_Annoyances_MobileApp/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_22_Annoyances_Widgets/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_21_Annoyances_Other/filter.txt"
            "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_224_Chinese/filter.txt"
            "https://easylist.to/easylist/easylist.txt"
            "https://easylist.to/easylist/easyprivacy.txt"
            "https://pgl.yoyo.org/as/serverlist.php?showintro=0;hostformat=hosts"
            "https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/badware.txt"
            "https://malware-filter.gitlab.io/malware-filter/urlhaus-filter-agh.txt"
          )

          echo "开始下载并拼接规则..."
          for url in "${URLS[@]}"; do
            echo "Downloading: $url"
            curl -sSL "$url" >> AdGE_uB_Mixed.txt
            echo -e "\n" >> AdGE_uB_Mixed.txt
          done
          
          echo "拼接完成，临时文件大小："
          ls -lh AdGE_uB_Mixed.txt

      - name: 2. Install hostlist-compiler
        run: npm install -g @adguard/hostlist-compiler

      - name: 3. Compress and Compile
        run: |
          cat <<EOF > config.json
          {
            "name": "AdGuard Extension Merge",
            "description": "Merged AdGuard filters with Deduplication",
            "version": "1.0.$(date +%s)",
            "homepage": "https://github.com/${{ github.repository }}",
            "sources": [
              {
                "source": "AdGE_uB_Mixed.txt",
                "type": "adblock"
              }
            ]
          }
          EOF

          hostlist-compiler -c config.json -o Mixed.txt
          
          rm AdGE_uB_Mixed.txt config.json

      - name: 4. Process (Deduplicate, Filter Length & Comments)
        shell: python
        run: |
          import urllib.request
          import os

          local_file = "Mixed.txt"
          upstream_url = "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt"
          
          print(f"正在下载参照列表: {upstream_url}")
          try:
              with urllib.request.urlopen(upstream_url) as response:
                  upstream_data = response.read().decode('utf-8')
              upstream_rules = set(line.strip() for line in upstream_data.splitlines() if line.strip())
              
              if not os.path.exists(local_file):
                  exit(1)

              with open(local_file, 'r', encoding='utf-8') as f:
                  local_lines = f.readlines()

              new_lines = []
              
              for line in local_lines:
                  clean_line = line.strip()
                  
                  # 1. 跳过空行
                  if not clean_line:
                      continue

                  # 2. 智能处理 '!' 开头的行
                  if clean_line.startswith('!'):
                      # 保留 !# 开头的特殊指令 (如 !#safari_cb_affinity, !#include)
                      if clean_line.startswith('!#'):
                          pass 
                      else:
                          # 删除普通注释
                          continue

                  # 3. 智能处理 '#' 开头的行
                  # 注意：在 AdBlock 语法中，## 是通用隐藏规则，不能删！
                  if clean_line.startswith('#'):
                      # 如果是 ## 或 #@# (白名单) 等规则开头，保留
                      if clean_line.startswith('##') or clean_line.startswith('#@#') or clean_line.startswith('#?#'):
                          pass
                      else:
                          # 删除 Hosts 文件的注释 (如 # 127.0.0.1)
                          continue

                  # 4. 删除超长行
                  if len(line) >= 1024:
                      continue

                  # 5. 上游去重
                  if clean_line in upstream_rules:
                      continue
                  else:
                      new_lines.append(line)

              print(f"处理完成，剩余规则数: {len(new_lines)}")

              with open(local_file, 'w', encoding='utf-8') as f:
                  f.writelines(new_lines)

          except Exception as e:
              print(f"脚本错误: {e}")
              exit(1)

      - name: 5. Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add Mixed.txt
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update filters: Cleaned & Deduplicated $(date +'%Y-%m-%d')"
            git push
          fi
